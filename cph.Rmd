---
title: "Cox Proportional Hazard Models"
output: html_document
---

```{r setup, include=FALSE}
library("survival")
library("survminer")
library("tidyverse")
```


# Cox Proportional Hazard Survival Models

Get the test dataset.  Target is week and arrest, week is the length of time, and arrest is the censoring variable.  8 predictor variables are single columns, while one variable is split out over all the 52 weeks (emp1-52).

```{r}
url <- "http://socserv.mcmaster.ca/jfox/Books/Companion/data/Rossi.txt"
rossi <- read.table(url, header=TRUE)
```

Fit an initial CPH model with all the variables available (except the time-dependent one).  Coefficients with a negative coefficient mean that the chances of being arrested are lower (higher survival chances), and vice versa.  Coefficients with positive coefficients (exp(coefficients) > 1) imply higher chances of being arrested (lower survival chances).

```{r}
cph_full <- coxph(Surv(week, arrest) ~ fin + age + race + wexp + mar + paro + prio,
                     data = rossi)

summary(cph_full)
```

Plot the survival curve from this model fit.
```{r}
ggsurvplot(survfit(cph_full), data = rossi, ylim = c(0.6, 1))
```

Show the specific predictions from the model for a couple different rows in the data.
```{r}
#rossi[1:5,3:10]
ggsurvplot(survfit(cph_full, newdata = rossi[1:5,]), data = rossi)
```

The cox proportional hazard model is a combination of a non-parametric 'baseline hazard' along with a parametric portion which is the 'proportional hazards given by exp(beta*X).  The relative differences between the proportional pieces of the hazard are given by the betas in the fit.  To get the baseline hazard, that can be pulled from the model using `basehaz()`.  This can be thought of as the 'q' in a mortality model before it is modified by the coefficients for each individual.  The survival curve can be derived from these values by stepping forward each time period and applying this hazard rate to get the probability of surviving to the next time period.
```{r}
#basehaz(cph_full)
ggplot(basehaz(cph_full)) + geom_line(aes(x = time, y = hazard))
```

There is one 'baseline hazard' rate fit for ALL observations.  This can be changed by using `strata()` in the formula when fitting the model.  This fits different baseline hazards for each strata in the group varaible.  For example, if we wanted to fit a different baseline hazard for married vs non-married individuals in the data, we would use the following code.

One question I still have: Are the coefficients the same between strata?  It would seem so given that the summary doens't show different coefficients by strata, but I'm not 100% sure.  To fit different coefficients, it's probably easier to just split the data in two and fit two models with different baseline hazards and coefficients.  This seems to imply that splitting the model by strata assumes that the factors affect different strata exactly the same way.  For example, the number of prior arrests has the same impact on survival regardless of whether or not the individual was married.  
```{r}
cph_full2 <- coxph(Surv(week, arrest) ~ fin + age + race + wexp + strata(mar) + paro + prio,
                     data = rossi)

summary(cph_full2)
```

Now that we fit a model with two strata, we can show the different baseline hazards for the two strata: married and non-married individuals:
```{r}
basehaz(cph_full2) %>%
  ggplot() + geom_line(aes(x = time, y = hazard, color = strata))
```

Compare the KM fit to the full cph fit
```{r}

```

How can we improve the fit of this model, and compare models with different sets of variables and different features?

Test out using log of the prior arrests to see if it improves performance.  Concordance goes up which is an indicator of better fit.  All the other tests go down, which I think is the right direction, but need to do more research on that.
```{r}
cph_full3 <- coxph(Surv(week, arrest) ~ fin + age + race + wexp + mar + paro + log(prio + 1),
                     data = rossi) 

summary(cph_full3)
```

One way to compare goodness of fit is to use AIC.  Looking at the AIC for the two models shows that the original model has a better fit, indicated by the lower AIC.  
```{r}
paste0("AIC on original model: ", extractAIC(cph_full)[2], "\n", "AIC on modified model: ", extractAIC(cph_full2)[2]) %>% writeLines

```
Compare km fit on one dimension to cph fit on one dimension
```{r}

```

Figure out how the cph formula actually works.  Does the cph fit 
```{r}

```